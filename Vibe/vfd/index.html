<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Поиск в базе данных ошибок</title>
    <!-- Подключаем SQL.js -->
    <script src="sql-wasm.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-bg: #eff6ff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --bg-body: #f3f4f6;
            --bg-white: #ffffff;
            --danger-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Предотвращаем скролл тела, скроллим только контейнеры */
        }

        /* === ВЕРХНЯЯ ПАНЕЛЬ (ПОИСК) === */
        .top-bar {
            background: var(--bg-white);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            z-index: 10;
        }

        .search-wrapper {
            position: relative;
            max-width: 100%;
        }

        .search-wrapper input {
            width: 100%;
            padding: 12px 40px 12px 16px; /* Место справа для кнопки справки */
            font-size: 16px; /* Чтобы не зумил на iOS */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f9fafb;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-wrapper input:focus {
            background: white;
            border-color: var(--primary-color);
        }

        .search-wrapper input:disabled {
            background: #eee;
            color: #aaa;
        }

        /* Кнопка справки внутри поиска */
        .help-btn-small {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .help-btn-small:hover, .help-btn-small:active {
            background: #eee;
            color: var(--primary-color);
        }

        /* Информационная панель */
        .info-panel {
            background: var(--primary-bg);
            border-bottom: 1px solid #dbeafe;
            padding: 10px 16px;
            font-size: 0.85em;
            color: #1e40af;
            display: none; /* Скрыта по умолчанию */
            flex-shrink: 0;
        }
        .info-panel.show { display: block; }

        /* === ОСНОВНАЯ ОБЛАСТЬ === */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            position: relative;
        }

        /* Список результатов */
        .results-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-right: 1px solid var(--border-color);
            min-width: 0; /* Важно для Flexbox */
        }

        .results-header {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding: 0 5px;
            display: flex;
            justify-content: space-between;
        }

        .result-item {
            padding: 12px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .result-item.active {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .r-source {
            font-size: 0.7em;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .r-code {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.95em;
            margin-bottom: 2px;
        }

        .r-name {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Детали (справа) */
        .detail-section {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
            display: none; /* Скрыто на мобильном по умолчанию, показываем при клике */
        }

        .detail-card {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .detail-field {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        .detail-field:last-child { border: none; }

        .detail-label {
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }

        .detail-value {
            font-size: 0.95em;
            color: var(--text-main);
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .highlight {
            background-color: #fef08a;
            color: #854d0e;
            padding: 1px 3px;
            border-radius: 3px;
        }

        /* === НИЖНЯЯ ПАНЕЛЬ (ФИЛЬТРЫ) === */
        .footer {
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            height: 140px; /* Фиксированная высота для фильтров */
            display: flex;
            flex-direction: column;
        }

        .footer-header {
            padding: 8px 16px;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid #f3f4f6;
            background: #fafafa;
        }

        .filters-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 16px;
        }

        /* Группы фильтров */
        .filter-group {
            margin-bottom: 12px;
        }

        .filter-group-title {
            font-size: 0.8em;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Чипсы фильтров */
        .filter-chip {
            display: inline-flex;
            align-items: center;
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: white;
            margin-right: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            user-select: none;
            color: var(--text-secondary);
            transition: all 0.1s;
        }

        .filter-chip.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Состояние "выключено" (серое/перечеркнутое) */
        .filter-chip.disabled {
            background: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Статусные сообщения */
        .status-msg {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 10px;
            text-align: center;
            background: rgba(255,255,255,0.95);
            z-index: 20;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        .status-msg.error { color: var(--danger-color); }
        .status-msg.loading { color: var(--primary-color); }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .results-list {
                width: 100%;
                border-right: none;
                flex: 1; /* Занимает все доступное место */
            }
            .detail-section {
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                z-index: 50;
                transform: translateX(100%);
                transition: transform 0.2s ease-in-out;
            }
            .detail-section.open {
                transform: translateX(0);
                display: block;
            }
            /* Кнопка "Назад" в деталях для мобильных */
            .back-btn {
                display: block;
                margin-bottom: 10px;
                padding: 8px;
                background: #eee;
                border-radius: 4px;
                text-align: center;
                cursor: pointer;
                font-size: 0.9em;
            }
        }
        @media (min-width: 769px) {
            .back-btn { display: none; }
            .detail-section { display: block; }
        }

        /* Утилитные классы */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ВЕРХНЯЯ ПАНЕЛЬ -->
    <div class="top-bar">
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Поиск..." disabled autocomplete="off">
            <button id="helpBtn" class="help-btn-small" title="Справка">?</button>
        </div>
    </div>

    <!-- ИНФОРМАЦИЯ -->
    <div id="infoPanel" class="info-panel">
        <strong>Поиск:</strong> Введите слова. Будут найдены записи, содержащие все эти слова.<br>
        <span id="dbListInfo" style="opacity: 0.8;"></span>
    </div>

    <!-- СООБЩЕНИЯ О СТАТУСЕ -->
    <div id="statusMsg" class="status-msg">Загрузка...</div>

    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <div class="main-container">
        <!-- СПИСОК -->
        <div class="results-list">
            <div class="results-header">
                <span>Результаты</span>
                <span id="countBadge">0</span>
            </div>
            <div id="resultsList"></div>
        </div>

        <!-- ДЕТАЛИ -->
        <div class="detail-section" id="detailSection">
            <div class="back-btn" id="backBtn">← Назад к списку</div>
            <div id="detailContent" class="detail-card">
                <div style="text-align:center; color:#999; padding: 20px;">Выберите запись</div>
            </div>
        </div>
    </div>

    <!-- НИЖНЯЯ ПАНЕЛЬ ФИЛЬТРОВ -->
    <div class="footer">
        <div class="footer-header">Фильтры (Базы и Таблицы)</div>
        <div class="filters-scroll-area" id="filtersArea">
            <!-- Фильтры генерируются JS -->
        </div>
    </div>

    <script>
        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        let databases = {};
        let config = null;
        let allData = [];
        let currentResults = [];
        let enabledDatabases = {}; // { "db_file": boolean }
        let enabledTables = {};     // { "db_file.table_name": boolean }
        let dbRecordCounts = {};

        // === ИНИЦИАЛИЗАЦИЯ ===
        document.addEventListener('DOMContentLoaded', async () => {
            const isConfigOk = await loadConfig();
            if (!isConfigOk) return;

            await loadAllDatabases();
            setupEvents();
            renderFilters();
            updateInfo();
            
            document.getElementById('searchInput').disabled = false;
            document.getElementById('searchInput').focus();
        });

        // === ЗАГРУЗКА КОНФИГА ===
        async function loadConfig() {
            showStatus('Загрузка конфигурации...', 'loading');
            try {
                const res = await fetch('config.json');
                if (!res.ok) throw new Error(res.statusText);
                config = await res.json();
                
                if (!config.databases) throw new Error('Нет списка баз данных');
                
                // Умолчания
                if (!config.maxDisplayResults) config.maxDisplayResults = 30;
                
                hideStatus();
                return true;
            } catch (e) {
                showStatus(`Ошибка конфига: ${e.message}`, 'error');
                return false;
            }
        }

        // === ЗАГРУЗКА БАЗ ДАННЫХ ===
        async function loadAllDatabases() {
            showStatus('Загрузка баз данных...', 'loading');
            enabledDatabases = {};
            enabledTables = {};
            dbRecordCounts = {};

            try {
                const SQL = await initSqlJs({
                    locateFile: file => "sql-wasm.wasm"
                });

                let totalRec = 0;

                for (const dbConf of config.databases) {
                    const dbName = dbConf.file || 'unknown';
                    enabledDatabases[dbName] = true; // Включены по умолчанию
                    
                    try {
                        const dbRes = await fetch(dbConf.url || dbName);
                        const u8array = new Uint8Array(await dbRes.arrayBuffer());
                        const db = new SQL.Database(u8array);
                        
                        databases[dbName] = { db, tables: {} };
                        
                        if (!dbConf.tables) continue;

                        for (const tblConf of dbConf.tables) {
                            const tblName = tblConf.name;
                            // Включаем таблицы по умолчанию
                            const tableKey = `${dbName}.${tblName}`;
                            enabledTables[tableKey] = true;

                            try {
                                const cols = tblConf.detailColumns.join(', ');
                                const query = `SELECT ${cols} FROM ${tblName}`;
                                const stmt = db.exec(query);
                                
                                let data = [];
                                if (stmt.length > 0) {
                                    const keys = stmt[0].columns;
                                    data = stmt[0].values.map(row => {
                                        let obj = {};
                                        keys.forEach((k, i) => obj[k] = row[i]);
                                        return obj;
                                    });
                                }
                                databases[dbName].tables[tblName] = data;
                            } catch (err) {
                                console.warn(`Ошибка чтения таблицы ${tblName}`, err);
                            }
                        }

                        // Считаем записи
                        const count = Object.values(databases[dbName].tables).reduce((a, b) => a + b.length, 0);
                        dbRecordCounts[dbName] = count;
                        totalRec += count;

                    } catch (err) {
                        console.error(`Ошибка загрузки DB ${dbName}`, err);
                        dbRecordCounts[dbName] = 0;
                    }
                }

                buildGlobalData();
                hideStatus();
                showStatus(`Готово: ${totalRec} записей`, 'loading');
                setTimeout(hideStatus, 1000);

            } catch (e) {
                showStatus(`Критическая ошибка: ${e.message}`, 'error');
            }
        }

        function buildGlobalData() {
            allData = [];
            for (const [dbName, dbInfo] of Object.entries(databases)) {
                const dbConfig = config.databases.find(d => d.file === dbName);
                if (!dbConfig) continue;

                for (const [tblName, tblData] of Object.entries(dbInfo.tables)) {
                    const tblConfig = dbConfig.tables.find(t => t.name === tblName);
                    if (!tblConfig) continue;

                    tblData.forEach(row => {
                        allData.push({
                            db: dbName,
                            table: tblName,
                            config: tblConfig,
                            data: row
                        });
                    });
                }
            }
        }

        // === ИНТЕРФЕЙС ФИЛЬТРОВ (БД + ТАБЛИЦЫ) ===
        function renderFilters() {
            const container = document.getElementById('filtersArea');
            container.innerHTML = '';

            config.databases.forEach(dbConf => {
                const dbName = dbConf.file;
                const dbEnabled = enabledDatabases[dbName];
                
                const group = document.createElement('div');
                group.className = 'filter-group';

                // Заголовок группы (База данных)
                const title = document.createElement('div');
                title.className = 'filter-group-title';
                title.innerHTML = `<span>${dbName}</span> <span style="font-weight:400; font-size:0.8em; color:#999;">(${dbRecordCounts[dbName]})</span>`;
                
                // Клик по заголовку переключает всю БД
                title.style.cursor = 'pointer';
                title.onclick = () => {
                    const newState = !enabledDatabases[dbName];
                    enabledDatabases[dbName] = newState;
                    
                    // При отключении БД отключаем и все её таблицы визуально
                    // При включении БД возвращаем таблицам их состояние (или включаем все)
                    // Проще: перерисовать фильтры
                    renderFilters(); 
                    performSearch(document.getElementById('searchInput').value);
                };

                group.appendChild(title);

                // Список таблиц
                const dbInfo = databases[dbName];
                if (dbInfo && dbConf.tables) {
                    dbConf.tables.forEach(tblConf => {
                        const tblName = tblConf.name;
                        const tableKey = `${dbName}.${tblName}`;
                        
                        // Проверяем, есть ли данные в таблице
                        if (!dbInfo.tables[tblName]) return;

                        const chip = document.createElement('span');
                        
                        // Состояние чипа зависит от: включена ли БДАТА И включена ли ТАБЛИЦА
                        const isDbActive = enabledDatabases[dbName];
                        const isTblActive = enabledTables[tableKey];
                        
                        let className = 'filter-chip';
                        if (!isDbActive || !isTblActive) {
                            className += ' disabled';
                        } else {
                            className += ' active';
                        }

                        chip.className = className;
                        chip.textContent = tblName;

                        chip.onclick = (e) => {
                            e.stopPropagation(); // Чтобы не триггерить клик по группе
                            
                            // Если БД выключена, сначала включим её
                            if (!enabledDatabases[dbName]) {
                                enabledDatabases[dbName] = true;
                            }
                            
                            // Переключаем таблицу
                            enabledTables[tableKey] = !enabledTables[tableKey];
                            
                            renderFilters();
                            performSearch(document.getElementById('searchInput').value);
                        };

                        group.appendChild(chip);
                    });
                }

                container.appendChild(group);
            });
        }

        // === ПОИСК ===
        function performSearch(query) {
            if (!query.trim()) {
                clearResults();
                return;
            }

            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            
            // Фильтрация
            let results = allData.filter(item => {
                // 1. Фильтр по БД
                if (!enabledDatabases[item.db]) return false;
                // 2. Фильтр по Таблице (ключевой функционал)
                const tableKey = `${item.db}.${item.table}`;
                if (!enabledTables[tableKey]) return false;
                
                return true;
            });

            // Текстовый поиск
            words.forEach(word => {
                results = results.filter(item => {
                    const cols = item.config.detailColumns;
                    return cols.some(col => String(item.data[col] || '').toLowerCase().includes(word));
                });
            });

            displayResults(results, words);
        }

        function displayResults(results, words) {
            currentResults = results;
            const listEl = document.getElementById('resultsList');
            const countEl = document.getElementById('countBadge');
            
            countEl.textContent = results.length;
            listEl.innerHTML = '';

            if (results.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Ничего не найдено</div>';
                return;
            }

            const limit = config.maxDisplayResults;
            if (results.length > limit) {
                listEl.innerHTML = `<div style="padding:10px; color:#ef4444; font-size:0.9em; text-align:center;">Найдено > ${limit} записей. Уточните запрос.</div>`;
                return;
            }

            // Фрагмент для быстрой отрисовки
            const frag = document.createDocumentFragment();

            results.forEach((item, idx) => {
                const dCols = item.config.displayColumns;
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => showDetail(idx);
                
                div.innerHTML = `
                    <div class="r-source">${item.db} &rarr; ${item.table}</div>
                    <div class="r-code">${esc(item.data[dCols[0]])}</div>
                    <div class="r-name">${esc(item.data[dCols[1]])}</div>
                `;
                frag.appendChild(div);
            });
            listEl.appendChild(frag);
        }

        function clearResults() {
            document.getElementById('resultsList').innerHTML = '';
            document.getElementById('countBadge').textContent = '0';
            document.getElementById('detailContent').innerHTML = '<div style="text-align:center; color:#999; padding: 20px;">Выберите запись</div>';
            // На мобильном скрываем детали при очистке
            document.getElementById('detailSection').classList.remove('open');
        }

        // === ДЕТАЛИЗАЦИЯ ===
        function showDetail(idx) {
            const item = currentResults[idx];
            
            // Подсветка активного элемента
            const allItems = document.querySelectorAll('.result-item');
            allItems.forEach(i => i.classList.remove('active'));
            if(allItems[idx]) allItems[idx].classList.add('active');

            const detailEl = document.getElementById('detailContent');
            const cols = item.config.detailColumns;
            const labels = item.config.customLabels || {};

            let html = '';
            cols.forEach(col => {
                const val = item.data[col] || '';
                const lbl = labels[col] || col;
                html += `
                    <div class="detail-field">
                        <span class="detail-label">${esc(lbl)}</span>
                        <div class="detail-value">${esc(val)}</div>
                    </div>
                `;
            });
            detailEl.innerHTML = html;

            // Показываем панель деталей (особенно важно для мобильных)
            document.getElementById('detailSection').classList.add('open');

            // Подсветка текста
            highlightWords(document.getElementById('searchInput').value);
        }

        function highlightWords(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            if (!words.length) return;

            document.querySelectorAll('.detail-value').forEach(el => {
                const text = el.textContent;
                // Простая замена с экранированием регулярок
                let newText = text;
                words.forEach(w => {
                    const reg = new RegExp(`(${escRegExp(w)})`, 'gi');
                    newText = newText.replace(reg, '<span class="highlight">$1</span>');
                });
                el.innerHTML = newText;
            });
        }

        // === СОБЫТИЯ ===
        function setupEvents() {
            // Поиск с debounce
            let timeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => performSearch(e.target.value), 300);
            });

            // Справка
            document.getElementById('helpBtn').addEventListener('click', () => {
                const p = document.getElementById('infoPanel');
                p.classList.toggle('show');
            });

            // Кнопка назад (мобильные)
            document.getElementById('backBtn').addEventListener('click', () => {
                document.getElementById('detailSection').classList.remove('open');
            });
        }

        function updateInfo() {
            const list = config.databases.map(d => d.file).join(', ');
            document.getElementById('dbListInfo').textContent = `Базы: ${list}`;
        }

        // === УТИЛИТЫ ===
        function showStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = `status-msg ${type}`;
            el.style.display = 'block';
        }
        function hideStatus() {
            document.getElementById('statusMsg').style.display = 'none';
        }
        function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g, "&amp;")
                             .replace(/</g, "&lt;")
                             .replace(/>/g, "&gt;")
                             .replace(/"/g, "&quot;")
                             .replace(/'/g, "&#039;");
        }
        function escRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    </script>
</body>
</html>