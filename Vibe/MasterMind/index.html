<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Mastermind - классическая логическая игра">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Mastermind">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="favicon.png" />
	<link rel="manifest" href="./manifest.json" />
	<script>
		if ("serviceWorker" in navigator) {
			window.addEventListener("load", () => {
				navigator.serviceWorker.register('/html/Vibe/MasterMind/sw.js', { scope: '/html/Vibe/MasterMind/' });
			});
		}
	</script>
    <title>Mastermind</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            min-height: 100vh;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: flex-end;
            padding-top: 50px;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 5vw;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: absolute;
            top: 5px;
            left: 10%;
            right: 10%;
            width: 80%;
            font-weight: 600;
        }
        
        .game-area {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #6c8ebd #2c3e50;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .game-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .game-area::-webkit-scrollbar-track {
            background: rgba(44, 62, 80, 0.3);
            border-radius: 4px;
        }
        
        .game-area::-webkit-scrollbar-thumb {
            background: #6c8ebd;
            border-radius: 4px;
        }
        
        .game-area::-webkit-scrollbar-thumb:hover {
            background: #7da0d6;
        }
        
        .sequence-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: auto;
            width: 100%;
        }
        
        .sequence-row {
            display: flex;
            gap: 2%;
            margin-bottom: 10px;
            align-items: center;
            width: 100%;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .attempt-number {
            font-size: 4vw;
            font-weight: 600;
            color: #e0e0e0;
            min-width: 8%;
            text-align: center;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .color-slots {
            display: flex;
            gap: 2%;
            width: 65%;
        }
        
        .color-slot {
            width: 20%;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            background: #2c3e50;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .feedback {
            display: flex;
            gap: 4px;
            margin-left: 2%;
            flex-wrap: wrap;
            width: 20%;
        }
        
        .feedback-dot {
            width: 30%;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: 1px solid #ffffff;
        }
        
        .black { background: #000000; }
        .white { background: #cccccc; }
        
        .color-palette {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 12px 0;
        }
        
        .palette-row {
            display: flex;
            gap: 4%;
            align-items: center;
            justify-content: flex-start;
            padding-left: 5%;
        }
        
        .color-circle {
            width: 15vw;
            height: 15vw;
            max-width: 70px;
            max-height: 70px;
            min-width: 45px;
            min-height: 45px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1/1;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .color-circle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .color-circle:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .control-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
        }
        
        .btn {
            padding: 2.5vw 4vw;
            font-size: 3.5vw;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .btn-check {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }
        
        .btn-remove {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-new-game {
            background: linear-gradient(135deg, #5d6d7e 0%, #4d5d6d 100%);
            min-width: 22%;
            font-size: 3vw;
        }
        
        .btn-help {
            background: linear-gradient(135deg, #5d6d7e 0%, #4d5d6d 100%);
            min-width: 22%;
            font-size: 3vw;
        }
        
        .btn-difficulty {
            background: linear-gradient(135deg, #5d6d7e 0%, #4d5d6d 100%);
            min-width: 22%;
            font-size: 3vw;
        }
        
        .btn-stats {
            background: linear-gradient(135deg, #5d6d7e 0%, #4d5d6d 100%);
            min-width: 22%;
            font-size: 3vw;
        }
        
        .btn-surrender {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
            min-width: 25%;
            font-size: 3vw;
        }
        
        .current-row {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: auto;
            padding: 5vw;
            border-radius: 12px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 80vw;
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal h2 {
            margin-bottom: 4vw;
            font-size: 5vw;
            font-weight: 600;
            color: #ecf0f1;
        }
        
        .modal p {
            margin-bottom: 3vw;
            font-size: 3.5vw;
            line-height: 1.5;
            color: #bdc3c7;
        }
        
        .modal-buttons {
            display: flex;
            gap: 3vw;
            justify-content: center;
            margin-top: 4vw;
            flex-wrap: wrap;
        }
        
        .modal-btn {
            padding: 2vw 4vw;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 3.5vw;
            min-height: 40px;
            margin: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .modal-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .close-btn {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 3vw;
            border-radius: 8px;
            margin: 3vw 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .secret-code {
            display: flex;
            justify-content: center;
            gap: 2vw;
            margin: 3vw 0;
        }
        
        .secret-color {
            width: 8vw;
            height: 8vw;
            max-width: 35px;
            max-height: 35px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.95);
            color: #ecf0f1;
            padding: 18px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 500;
            z-index: 2000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-align: center;
            min-width: 250px;
        }
        
        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin: 25px 0;
        }
        
        .difficulty-option {
            padding: 18px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .difficulty-option:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .difficulty-option.selected {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .difficulty-option h3 {
            color: #ecf0f1;
            margin-bottom: 8px;
            font-size: 4vw;
        }
        
        .difficulty-option p {
            color: #bdc3c7;
            font-size: 3vw;
            line-height: 1.4;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 6vw;
            font-weight: 700;
            color: #27ae60;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 3vw;
            color: #bdc3c7;
        }
        
        .difficulty-stats {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .difficulty-stats h3 {
            color: #ecf0f1;
            margin-bottom: 10px;
            font-size: 4vw;
        }
        
        .difficulty-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 3vw;
        }
        
        .difficulty-name {
            color: #bdc3c7;
        }
        
        .difficulty-value {
            color: #27ae60;
            font-weight: 600;
        }
        
        @media (max-width: 480px) {
            .color-circle {
                width: 14vw;
                height: 14vw;
                max-width: 65px;
                max-height: 65px;
                min-width: 40px;
                min-height: 40px;
            }
            
            .btn {
                padding: 2vw 3vw;
                font-size: 3vw;
            }
            
            .btn-new-game, .btn-help, .btn-difficulty, .btn-stats {
                font-size: 2.5vw;
            }
            
            .modal-content {
                padding: 4vw;
            }
            
            .modal h2 {
                font-size: 4.5vw;
            }
            
            .modal p {
                font-size: 3vw;
            }
            
            .modal-btn {
                font-size: 3vw;
            }
            
            .container {
                padding-top: 40px;
            }
            
            h1 {
                font-size: 6vw;
            }
            
            .notification {
                font-size: 16px;
                padding: 15px 25px;
                min-width: 220px;
            }
            
            .difficulty-option h3 {
                font-size: 16px;
            }
            
            .difficulty-option p {
                font-size: 14px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 14px;
            }
            
            .difficulty-stats h3 {
                font-size: 16px;
            }
            
            .difficulty-row {
                font-size: 14px;
            }
        }
        
        @media (min-width: 768px) {
            .color-circle {
                width: 65px;
                height: 65px;
            }
            
            .btn {
                font-size: 16px;
                padding: 12px 20px;
            }
            
            .btn-new-game, .btn-help, .btn-difficulty, .btn-stats {
                font-size: 15px;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .modal h2 {
                font-size: 26px;
            }
            
            .modal p {
                font-size: 17px;
            }
            
            .modal-btn {
                font-size: 16px;
                padding: 12px 20px;
            }
            
            h1 {
                font-size: 30px;
            }
            
            .notification {
                font-size: 19px;
                padding: 20px 35px;
                min-width: 300px;
            }
            
            .difficulty-option h3 {
                font-size: 20px;
            }
            
            .difficulty-option p {
                font-size: 16px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .stat-label {
                font-size: 16px;
            }
            
            .difficulty-stats h3 {
                font-size: 20px;
            }
            
            .difficulty-row {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mastermind</h1>
        
        <div class="game-area" id="gameArea">
            <div class="sequence-container" id="sequenceContainer">
                <!-- Игровые строки будут добавляться здесь -->
            </div>
        </div>
        
        <div class="color-palette">
            <div class="palette-row">
                <div class="color-circle" style="background: #FF4136;" data-color="#FF4136"></div>
                <div class="color-circle" style="background: #0074D9;" data-color="#0074D9"></div>
                <div class="color-circle" style="background: #2ECC40;" data-color="#2ECC40"></div>
                <button class="btn btn-check" id="checkBtn">Проверить</button>
            </div>
            <div class="palette-row">
                <div class="color-circle" style="background: #FFDC00;" data-color="#FFDC00"></div>
                <div class="color-circle" style="background: #FF69B4;" data-color="#FF69B4"></div>
                <div class="color-circle" style="background: #FF851B;" data-color="#FF851B"></div>
                <div>
                    <button class="btn btn-remove" id="removeBtn">Убрать</button>
                    <button class="btn btn-surrender" id="surrenderBtn" style="display: none;">Сдаться</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <button class="btn btn-new-game" id="newGameBtn">Новая игра</button>
                <button class="btn btn-difficulty" id="difficultyBtn">Сложность</button>
                <button class="btn btn-help" id="helpBtn">Помощь</button>
                <button class="btn btn-stats" id="statsBtn">Статистика</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно победы -->
    <div id="winModal" class="modal">
        <div class="modal-content">
            <h2>🎉 Поздравляем! 🎉</h2>
            <p>Вы успешно угадали последовательность!</p>
            <div class="stats">
                <p>Количество попыток: <span id="attemptsCount">0</span></p>
            </div>
            <p>Правильная последовательность:</p>
            <div class="secret-code" id="winSecretCode">
                <!-- Цвета будут добавлены здесь -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn close-btn" id="closeWinModal">Продолжить</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно помощи -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <h2>❓ Помощь ❓</h2>
            <p><strong>Цель игры:</strong> Угадать секретную последовательность из 4 цветов.</p>
            <p><strong>Как играть:</strong></p>
            <p>1. Выбирайте цвета, нажимая на кружки внизу экрана</p>
            <p>2. Заполните строку 4 цветами</p>
            <p>3. Нажмите "Проверить" для получения подсказок</p>
            <p>4. Черные точки = правильный цвет на правильном месте</p>
            <p>5. Серые точки = правильный цвет на неправильном месте</p>
            <p>6. Цвета в последовательности могут повторяться!</p>
            <p>7. Угадайте последовательность за минимальное количество попыток!</p>
            <div class="modal-buttons">
                <button class="modal-btn close-btn" id="closeHelpModal">Закрыть</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно поражения -->
    <div id="loseModal" class="modal">
        <div class="modal-content">
            <h2>😔 Игра окончена</h2>
            <p>Вы не смогли угадать последовательность.</p>
            <p>Правильная последовательность:</p>
            <div class="secret-code" id="loseSecretCode">
                <!-- Цвета будут добавлены здесь -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn close-btn" id="closeLoseModal">Новая игра</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно выбора сложности -->
    <div id="difficultyModal" class="modal">
        <div class="modal-content">
            <h2>🎚️ Выбор сложности</h2>
            <div class="difficulty-selector">
                <div class="difficulty-option" data-difficulty="1">
                    <h3>Легкий (20 попыток)</h3>
                    <p>Больше времени на размышление. Доступна кнопка "Сдаться"</p>
                </div>
                <div class="difficulty-option" data-difficulty="2">
                    <h3>Средний (10 попыток)</h3>
                    <p>Стандартная сложность игры</p>
                </div>
                <div class="difficulty-option" data-difficulty="3">
                    <h3>Сложный (6 попыток)</h3>
                    <p>Минимум попыток для настоящих мастеров</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn close-btn" id="closeDifficultyModal">Закрыть</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно сдачи -->
    <div id="surrenderModal" class="modal">
        <div class="modal-content">
            <h2>🏳️ Сдача</h2>
            <p>Правильная последовательность:</p>
            <div class="secret-code" id="surrenderSecretCode">
                <!-- Цвета будут добавлены здесь -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn close-btn" id="closeSurrenderModal">Закрыть</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно статистики -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <h2>📊 Статистика</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalGames">0</div>
                    <div class="stat-label">Всего игр</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalWins">0</div>
                    <div class="stat-label">Побед</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Процент побед</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgAttempts">0</div>
                    <div class="stat-label">Сред. попыток</div>
                </div>
            </div>
            
            <div class="difficulty-stats">
                <h3>По сложности:</h3>
                <div class="difficulty-row">
                    <span class="difficulty-name">Легкий:</span>
                    <span class="difficulty-value" id="easyStats">0/0 (0%)</span>
                </div>
                <div class="difficulty-row">
                    <span class="difficulty-name">Средний:</span>
                    <span class="difficulty-value" id="mediumStats">0/0 (0%)</span>
                </div>
                <div class="difficulty-row">
                    <span class="difficulty-name">Сложный:</span>
                    <span class="difficulty-value" id="hardStats">0/0 (0%)</span>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn reset-btn" id="resetStatsBtn">Сбросить</button>
                <button class="modal-btn close-btn" id="closeStatsModal">Закрыть</button>
            </div>
        </div>
    </div>
    
    <!-- Уведомление -->
    <div id="notification" class="notification"></div>

    <script>
        class MastermindGame {
            constructor() {
                this.colors = ['#FF4136', '#0074D9', '#2ECC40', '#FFDC00', '#FF69B4', '#FF851B'];
                this.sequenceLength = 4;
                this.difficulty = 2; // 1 - легкий (20), 2 - средний (10), 3 - сложный (6)
                this.maxAttempts = 10;
                this.currentAttempt = 0;
                this.secretCode = this.generateSecretCode();
                this.gameArea = document.getElementById('gameArea');
                this.sequenceContainer = document.getElementById('sequenceContainer');
                this.removeBtn = document.getElementById('removeBtn');
                this.checkBtn = document.getElementById('checkBtn');
                this.newGameBtn = document.getElementById('newGameBtn');
                this.helpBtn = document.getElementById('helpBtn');
                this.difficultyBtn = document.getElementById('difficultyBtn');
                this.statsBtn = document.getElementById('statsBtn');
                this.surrenderBtn = document.getElementById('surrenderBtn');
                this.winModal = document.getElementById('winModal');
                this.helpModal = document.getElementById('helpModal');
                this.loseModal = document.getElementById('loseModal');
                this.difficultyModal = document.getElementById('difficultyModal');
                this.surrenderModal = document.getElementById('surrenderModal');
                this.statsModal = document.getElementById('statsModal');
                this.closeWinModal = document.getElementById('closeWinModal');
                this.closeHelpModal = document.getElementById('closeHelpModal');
                this.closeLoseModal = document.getElementById('closeLoseModal');
                this.closeDifficultyModal = document.getElementById('closeDifficultyModal');
                this.closeSurrenderModal = document.getElementById('closeSurrenderModal');
                this.closeStatsModal = document.getElementById('closeStatsModal');
                this.resetStatsBtn = document.getElementById('resetStatsBtn');
                this.notification = document.getElementById('notification');
                
                this.gameStartTime = Date.now();
                this.loadStats();
                this.initializeGame();
                this.bindEvents();
            }
            
            getAttemptsByDifficulty(difficulty) {
                switch(difficulty) {
                    case 1: return 20;
                    case 2: return 10;
                    case 3: return 6;
                    default: return 10;
                }
            }
            
            generateSecretCode() {
                const code = [];
                for (let i = 0; i < this.sequenceLength; i++) {
                    const randomIndex = Math.floor(Math.random() * this.colors.length);
                    code.push(this.colors[randomIndex]);
                }
                return code;
            }
            
            initializeGame() {
                this.sequenceContainer.innerHTML = '';
                this.currentAttempt = 0;
                this.maxAttempts = this.getAttemptsByDifficulty(this.difficulty);
                this.gameStartTime = Date.now();
                this.updateSurrenderButton();
                this.addNewRow();
            }
            
            addNewRow() {
                if (this.currentAttempt >= this.maxAttempts) return;
                
                const row = document.createElement('div');
                row.className = 'sequence-row current-row';
                row.id = `row-${this.currentAttempt}`;
                
                // Номер попытки
                const attemptNumber = document.createElement('div');
                attemptNumber.className = 'attempt-number';
                attemptNumber.textContent = this.currentAttempt + 1;
                row.appendChild(attemptNumber);
                
                // Слоты для цветов
                const colorSlots = document.createElement('div');
                colorSlots.className = 'color-slots';
                
                for (let i = 0; i < this.sequenceLength; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'color-slot';
                    slot.dataset.index = i;
                    colorSlots.appendChild(slot);
                }
                
                row.appendChild(colorSlots);
                
                this.sequenceContainer.appendChild(row);
                this.currentAttempt++;
                
                // Прокручиваем к новой строке
                this.scrollToBottom();
            }
            
            scrollToBottom() {
                // Прокручиваем к новой строке с небольшой задержкой
                setTimeout(() => {
                    this.gameArea.scrollTop = this.gameArea.scrollHeight;
                }, 50);
            }
            
            getCurrentRow() {
                return document.querySelector('.current-row');
            }
            
            addColorToRow(color) {
                const currentRow = this.getCurrentRow();
                if (!currentRow) return;
                
                const slots = currentRow.querySelectorAll('.color-slot');
                for (let slot of slots) {
                    if (!slot.style.backgroundColor) {
                        slot.style.backgroundColor = color;
                        slot.dataset.color = color;
                        break;
                    }
                }
            }
            
            removeLastColor() {
                const currentRow = this.getCurrentRow();
                if (!currentRow) return;
                
                const slots = Array.from(currentRow.querySelectorAll('.color-slot'));
                for (let i = slots.length - 1; i >= 0; i--) {
                    if (slots[i].style.backgroundColor) {
                        slots[i].style.backgroundColor = '';
                        delete slots[i].dataset.color;
                        break;
                    }
                }
            }
            
            showNotification(message) {
                this.notification.textContent = message;
                this.notification.style.display = 'block';
                setTimeout(() => {
                    this.notification.style.display = 'none';
                }, 2000);
            }
            
            checkCurrentRow() {
                const currentRow = this.getCurrentRow();
                if (!currentRow) return;
                
                const slots = currentRow.querySelectorAll('.color-slot');
                const userColors = Array.from(slots).map(slot => slot.dataset.color || null);
                
                // Проверяем, заполнена ли вся строка
                if (userColors.includes(null)) {
                    this.showNotification('Заполните всю последовательность!');
                    return;
                }
                
                // Убираем класс текущей строки
                currentRow.classList.remove('current-row');
                
                // Добавляем индикаторы обратной связи
                const feedback = document.createElement('div');
                feedback.className = 'feedback';
                currentRow.appendChild(feedback);
                
                // Вычисляем обратную связь
                const result = this.calculateFeedback(userColors);
                
                // Добавляем точки обратной связи только если есть совпадения
                if (result.black > 0 || result.white > 0) {
                    // Сначала черные точки
                    for (let i = 0; i < result.black; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'feedback-dot black';
                        feedback.appendChild(dot);
                    }
                    
                    // Затем серые точки
                    for (let i = 0; i < result.white; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'feedback-dot white';
                        feedback.appendChild(dot);
                    }
                }
                
                // Проверяем победу
                if (result.black === this.sequenceLength) {
                    const gameTime = Date.now() - this.gameStartTime;
                    this.showWinModal(this.currentAttempt, gameTime);
                    this.updateStats(true, this.currentAttempt, gameTime);
                    return;
                }
                
                // Проверяем поражение
                if (this.currentAttempt >= this.maxAttempts) {
                    const gameTime = Date.now() - this.gameStartTime;
                    this.showLoseModal();
                    this.updateStats(false, this.maxAttempts, gameTime);
                    return;
                }
                
                // Добавляем новую строку
                this.addNewRow();
            }
            
            showWinModal(attempts, gameTime) {
                document.getElementById('attemptsCount').textContent = attempts;
                const secretCodeContainer = document.getElementById('winSecretCode');
                secretCodeContainer.innerHTML = '';
                
                this.secretCode.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'secret-color';
                    colorDiv.style.backgroundColor = color;
                    secretCodeContainer.appendChild(colorDiv);
                });
                
                this.winModal.style.display = 'flex';
            }
            
            showLoseModal() {
                const secretCodeContainer = document.getElementById('loseSecretCode');
                secretCodeContainer.innerHTML = '';
                
                this.secretCode.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'secret-color';
                    colorDiv.style.backgroundColor = color;
                    secretCodeContainer.appendChild(colorDiv);
                });
                
                this.loseModal.style.display = 'flex';
            }
            
            showSurrenderModal() {
                const secretCodeContainer = document.getElementById('surrenderSecretCode');
                secretCodeContainer.innerHTML = '';
                
                this.secretCode.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'secret-color';
                    colorDiv.style.backgroundColor = color;
                    secretCodeContainer.appendChild(colorDiv);
                });
                
                this.surrenderModal.style.display = 'flex';
            }
            
            updateSurrenderButton() {
                // Показываем кнопку сдаться только в легком режиме
                if (this.difficulty === 1) {
                    this.surrenderBtn.style.display = 'block';
                } else {
                    this.surrenderBtn.style.display = 'none';
                }
            }
            
            calculateFeedback(userColors) {
                let black = 0; // Правильный цвет на правильной позиции
                let white = 0; // Правильный цвет на неправильной позиции
                
                // Создаем копии для подсчета
                const secretCopy = [...this.secretCode];
                const userCopy = [...userColors];
                const usedSecret = new Array(this.sequenceLength).fill(false);
                const usedUser = new Array(this.sequenceLength).fill(false);
                
                // Сначала считаем черные точки (точные совпадения)
                for (let i = 0; i < this.sequenceLength; i++) {
                    if (userCopy[i] === secretCopy[i]) {
                        black++;
                        usedSecret[i] = true;
                        usedUser[i] = true;
                    }
                }
                
                // Затем считаем серые точки (цвета на неправильных позициях)
                for (let i = 0; i < this.sequenceLength; i++) {
                    if (!usedUser[i]) {
                        for (let j = 0; j < this.sequenceLength; j++) {
                            if (!usedSecret[j] && userCopy[i] === secretCopy[j]) {
                                white++;
                                usedSecret[j] = true;
                                break;
                            }
                        }
                    }
                }
                
                return { black, white };
            }
            
            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.initializeGame();
                
                // Обновляем выделение в модальном окне
                document.querySelectorAll('.difficulty-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (parseInt(opt.dataset.difficulty) === difficulty) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            // Статистика
            loadStats() {
                const savedStats = localStorage.getItem('mastermindStats');
                if (savedStats) {
                    this.stats = JSON.parse(savedStats);
                } else {
                    this.stats = {
                        totalGames: 0,
                        totalWins: 0,
                        totalAttempts: 0,
                        totalTime: 0,
                        difficulty: {
                            1: { games: 0, wins: 0 },
                            2: { games: 0, wins: 0 },
                            3: { games: 0, wins: 0 }
                        }
                    };
                }
            }
            
            saveStats() {
                localStorage.setItem('mastermindStats', JSON.stringify(this.stats));
            }
            
            updateStats(isWin, attempts, gameTime) {
                this.stats.totalGames++;
                this.stats.totalAttempts += attempts;
                this.stats.totalTime += gameTime;
                
                if (isWin) {
                    this.stats.totalWins++;
                }
                
                // Обновляем статистику по сложности
                this.stats.difficulty[this.difficulty].games++;
                if (isWin) {
                    this.stats.difficulty[this.difficulty].wins++;
                }
                
                this.saveStats();
            }
            
            resetStats() {
                if (confirm('Вы уверены, что хотите сбросить всю статистику? Это действие нельзя отменить.')) {
                    this.stats = {
                        totalGames: 0,
                        totalWins: 0,
                        totalAttempts: 0,
                        totalTime: 0,
                        difficulty: {
                            1: { games: 0, wins: 0 },
                            2: { games: 0, wins: 0 },
                            3: { games: 0, wins: 0 }
                        }
                    };
                    this.saveStats();
                    this.updateStatsDisplay();
                }
            }
            
            updateStatsDisplay() {
                document.getElementById('totalGames').textContent = this.stats.totalGames;
                document.getElementById('totalWins').textContent = this.stats.totalWins;
                
                const winRate = this.stats.totalGames > 0 ? 
                    Math.round((this.stats.totalWins / this.stats.totalGames) * 100) : 0;
                document.getElementById('winRate').textContent = `${winRate}%`;
                
                const avgAttempts = this.stats.totalGames > 0 ? 
                    (this.stats.totalAttempts / this.stats.totalGames).toFixed(1) : 0;
                document.getElementById('avgAttempts').textContent = avgAttempts;
                
                // Статистика по сложности
                const easyStats = this.stats.difficulty[1];
                const easyRate = easyStats.games > 0 ? 
                    Math.round((easyStats.wins / easyStats.games) * 100) : 0;
                document.getElementById('easyStats').textContent = 
                    `${easyStats.wins}/${easyStats.games} (${easyRate}%)`;
                
                const mediumStats = this.stats.difficulty[2];
                const mediumRate = mediumStats.games > 0 ? 
                    Math.round((mediumStats.wins / mediumStats.games) * 100) : 0;
                document.getElementById('mediumStats').textContent = 
                    `${mediumStats.wins}/${mediumStats.games} (${mediumRate}%)`;
                
                const hardStats = this.stats.difficulty[3];
                const hardRate = hardStats.games > 0 ? 
                    Math.round((hardStats.wins / hardStats.games) * 100) : 0;
                document.getElementById('hardStats').textContent = 
                    `${hardStats.wins}/${hardStats.games} (${hardRate}%)`;
            }
            
            bindEvents() {
                // Добавление цветов
                document.querySelectorAll('.color-circle').forEach(circle => {
                    circle.addEventListener('click', (e) => {
                        const color = e.target.dataset.color;
                        this.addColorToRow(color);
                    });
                });
                
                // Кнопка "Убрать"
                this.removeBtn.addEventListener('click', () => {
                    this.removeLastColor();
                });
                
                // Кнопка "Проверить"
                this.checkBtn.addEventListener('click', () => {
                    this.checkCurrentRow();
                });
                
                // Кнопка "Новая игра"
                this.newGameBtn.addEventListener('click', () => {
                    this.secretCode = this.generateSecretCode();
                    this.initializeGame();
                });
                
                // Кнопка "Помощь"
                this.helpBtn.addEventListener('click', () => {
                    this.helpModal.style.display = 'flex';
                });
                
                // Кнопка "Сложность"
                this.difficultyBtn.addEventListener('click', () => {
                    this.difficultyModal.style.display = 'flex';
                });
                
                // Кнопка "Статистика"
                this.statsBtn.addEventListener('click', () => {
                    this.updateStatsDisplay();
                    this.statsModal.style.display = 'flex';
                });
                
                // Кнопка "Сдаться"
                this.surrenderBtn.addEventListener('click', () => {
                    const gameTime = Date.now() - this.gameStartTime;
                    this.updateStats(false, this.currentAttempt, gameTime);
                    this.showSurrenderModal();
                });
                
                // Выбор сложности
                document.querySelectorAll('.difficulty-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const difficulty = parseInt(e.target.closest('.difficulty-option').dataset.difficulty);
                        this.setDifficulty(difficulty);
                        this.difficultyModal.style.display = 'none';
                    });
                });
                
                // Закрытие модальных окон
                this.closeWinModal.addEventListener('click', () => {
                    this.winModal.style.display = 'none';
                });
                
                this.closeHelpModal.addEventListener('click', () => {
                    this.helpModal.style.display = 'none';
                });
                
                this.closeLoseModal.addEventListener('click', () => {
                    this.loseModal.style.display = 'none';
                    this.secretCode = this.generateSecretCode();
                    this.initializeGame();
                });
                
                this.closeDifficultyModal.addEventListener('click', () => {
                    this.difficultyModal.style.display = 'none';
                });
                
                this.closeSurrenderModal.addEventListener('click', () => {
                    this.surrenderModal.style.display = 'none';
                });
                
                this.closeStatsModal.addEventListener('click', () => {
                    this.statsModal.style.display = 'none';
                });
                
                this.resetStatsBtn.addEventListener('click', () => {
                    this.resetStats();
                });
                
                // Закрытие модальных окон при клике вне контента
                window.addEventListener('click', (e) => {
                    if (e.target === this.winModal) {
                        this.winModal.style.display = 'none';
                    }
                    if (e.target === this.helpModal) {
                        this.helpModal.style.display = 'none';
                    }
                    if (e.target === this.loseModal) {
                        this.loseModal.style.display = 'none';
                        this.secretCode = this.generateSecretCode();
                        this.initializeGame();
                    }
                    if (e.target === this.difficultyModal) {
                        this.difficultyModal.style.display = 'none';
                    }
                    if (e.target === this.surrenderModal) {
                        this.surrenderModal.style.display = 'none';
                    }
                    if (e.target === this.statsModal) {
                        this.statsModal.style.display = 'none';
                    }
                });
                
                // Поддержка клавиатуры для тестирования
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '6') {
                        const color = this.colors[parseInt(e.key) - 1];
                        this.addColorToRow(color);
                    } else if (e.key === 'Backspace') {
                        this.removeLastColor();
                    } else if (e.key === 'Enter') {
                        this.checkCurrentRow();
                    } else if (e.key === 'Escape') {
                        this.winModal.style.display = 'none';
                        this.helpModal.style.display = 'none';
                        this.loseModal.style.display = 'none';
                        this.difficultyModal.style.display = 'none';
                        this.surrenderModal.style.display = 'none';
                        this.statsModal.style.display = 'none';
                    }
                });
                
                // Обработка прокрутки колесиком мыши
                this.gameArea.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    this.gameArea.scrollTop += e.deltaY;
                });
                
                // Устанавливаем начальное выделение для средней сложности
                document.querySelector('.difficulty-option[data-difficulty="2"]').classList.add('selected');
            }
        }
        
        // Инициализация игры
        document.addEventListener('DOMContentLoaded', () => {
            new MastermindGame();
        });
    </script>
</body>
</html>