<!DOCTYPE HTML>
<html  id="slider">
<head>
<link rel="shortcut icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAdCAYAAABWk2cPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAADeSURBVEhLzZNJDsIwDEU5HEW0PQwSww6ph8sZyjKLSHANo1hQmdTNPPAlq3US6yX+yQ4ayAs6TROG+a9Fx+nXpiCob7jUpr1CCKgdCJVSYlvm+YGDSinM9Tidz5X/QLcWxeTf4ObbtZcqR94PV9h3Zwxuvgh0HE9wON7qQzvXSWsHe9LX876Ezl3tovKp94ba2kXlU+8F7YcLFsRCzfr/8ZRK5+ud298hFVcfBU29WNHQlIvVztNUj0LrEZrqUWj9As35+Km4vJ2n5s5Le8xCS3u8CS3pcRtPPxuoKIA3IkAxzZg1dXIAAAAASUVORK5CYII=" />

<style>
    * {
		touch-action: manipulation;
	}
	body {	
		background-color:Snow;
		font-size:2.5vh;
	}
	input{
		font-size:2.5vh;
	}
	p {
		margin:0.3em;
		font-size:3.5vh;
	}
    table {
		border-collapse: collapse;
		font-size:3.5vh;
		width:90%;
		
    }
    td, th {
		border: 1px solid black;
		padding: 3px;
		text-align: center;
		height:4vh;
		width:12%;
    }
    th {
		font-weight: bold;
		background-color: #E6E6E6;
    }
	#content{
		margin: 0 auto ;
		max-width: 450px;
		position:relative;
	}
	@media (orientation: portrait) {
		#content{
			max-width:100%;
		}
	}

</style>
</head>

<body>



<div id="content" align="center">
<div id="settings" style="display:none;">
	<p style="font-size:1em;">Дважды щелкнуть по дню чтобы выделить его зеленым цветом. Если щелкнуть дважды по зеленому полю, оно станет красным. Если щелкнуть по красному дважды, то вернется в свое первоначальное состояние. Поменять номер бригады можно кнопками ниже.</p>
	<input style = "width:23%; height:8vh;" type="button" onclick ="localStorage.setItem('storedshift', 0); monthset();" value="1 бр."/> 
	<input style = "width:23%; height:8vh;" type="button" onclick ="localStorage.setItem('storedshift', 1); monthset();" value="2 бр."/> 
	<input style = "width:23%; height:8vh;" type="button" onclick ="localStorage.setItem('storedshift', 2); monthset();" value="3 бр."/> 
	<input style = "width:23%; height:8vh;" type="button" onclick ="localStorage.setItem('storedshift', 3); monthset();" value="4 бр."/> 
	<br>
	<input style = "width:97%; height:5vh"type="button" onclick="clearstorage();" value="Удалить все отметки">
	<br><br>
	<input style = "width:48%; height:4vh;" type="button" onclick ="monthchange('back')" value="<<< Предыдущий"/> 
	<input style = "width:48%; height:4vh; " type="button" onclick ="monthchange('ff')" value="Следующий >>>"/>
</div>
	<p align ='center'>График на <span id="header"></span></p>
	<div id="calendar"></div>
	<br>
	<input style = "height:6vh;" type="button" onclick ="monthchange('back')" value="<"/><input id="today" style = "width:70%; height:6vh; white-space:normal;" type="button" onclick ="monthchange('zero');" value="Этот месяц"/><input style = "height:6vh; " type="button" onclick ="monthchange('ff')" value=">"/>
	<div id ="sh-counters"></div>
	<div id ="dn-counters"></div>
</div>

<div style="position:absolute; top:1%;right:1%;">
	<input type="button" onclick ="togglesettings()" style="font-size:4vh;" value="≡"/> 	
</div>	
	
<script>

	let changemonth = 0;
	let myshift =0;
	let forsave = new Date();
	forsave.setHours(0,0,0,0);
	let touchstartX = 0;
	let touchendX = 0;
	
	//slider function from stack-overflow to change month by slide to right-left
	const slider = document.getElementById('slider');

	function handleGesture() {
		if (touchendX+120 < touchstartX) monthchange('ff');
		if (touchendX -120 > touchstartX) monthchange('back');
	}
	slider.addEventListener('touchstart', e => {
		touchstartX = e.changedTouches[0].screenX;
		});

	slider.addEventListener('touchend', e => {
		touchendX = e.changedTouches[0].screenX;
		handleGesture();
		});

	function monthset(){
		let today = new Date();
		let thisdate = new Date();
		thisdate.setDate (1);
		thisdate.setMonth (today.getMonth() + changemonth);
		document.getElementById('today').value = "Сегодня "+ today.toLocaleString("ru",{year: 'numeric', month: 'long',day:'numeric'});
		let thismonth = thisdate.getMonth();
		let thisyear = thisdate.getFullYear();
		document.getElementById("header").innerHTML = thisdate.toLocaleString("ru",{year: 'numeric', month: 'long'});
		createCalendar(calendar, thisyear, thismonth);
	}
	
	function selectday(day,month){
		forsave.setDate(day);
		forsave.setMonth(month);
		if (localStorage.getItem(forsave.valueOf()) == "r") localStorage.removeItem(forsave.valueOf());
		else if (localStorage.getItem(forsave.valueOf()) == "g") localStorage.setItem(forsave.valueOf(), "r");
		else localStorage.setItem(forsave.valueOf(), "g");
		createCalendar(calendar, forsave.getFullYear(), forsave.getMonth());
	}
	
	function clearstorage(){
		for(let key in localStorage){
			localStorage.removeItem(key);
		}
		document.location.reload(true);
	}
	
    function createCalendar(elem, year, month) {

      let d = new Date(year, month);

      let table = '<table align="center"><tr><th>пн</th><th>вт</th><th>ср</th><th>чт</th><th>пт</th><th>сб</th><th>вс</th></tr><tr>';

      // пробелы для первого ряда
      // с понедельника до первого дня месяца
      // * * * 1  2  3  4
      for (let i = 0; i < getDay(d); i++) {
        table += '<td></td>';
      }
		let nightscount = 0;
		let dayscount = 0;
      // <td> ячейки календаря с датами
      while (d.getMonth() == month) {


		let buf = new Date();
		buf.setHours(0,0,0,0);
		let dayshift = new Date(2021,02,11);
		let nigthshift = new Date(2021,02,12);
		
		if (localStorage.getItem('storedshift') != null) myshift = parseInt(localStorage.getItem('storedshift')); else myshift=0;
		
		dayshift.setDate(dayshift.getDate()+ myshift);
		nigthshift.setDate(nigthshift.getDate()+ myshift);

		let nsdate = Math.floor(Math.abs(nigthshift - d)/(1000*60*60*24));
		let dsdate = Math.floor(Math.abs(dayshift - d)/(1000*60*60*24));
		let daystyle ="";
		
		if (Math.floor(Math.abs(buf - d)/(1000*60*60*24))==0) daystyle = daystyle + "border:3px; border-style:solid; border-color:red;"; 
		if (nsdate % 4 ==0) {
			daystyle = daystyle +"background-color: #444477; color:white;";
			nightscount++;
			}
		else if (dsdate %4 ==0){
			daystyle = daystyle +"background-color: #eeee77;";
			dayscount++;
			}
		if (localStorage.getItem(d.valueOf()) == "g") daystyle = daystyle + "background-color:GreenYellow;";
		else if (localStorage.getItem(d.valueOf()) == "r") daystyle = daystyle + "background-color:Pink;";
				
		table += '<td ondblclick="selectday('+d.getDate()+','+d.getMonth()+');" style="'+daystyle +'">'+ d.getDate() + '</td>';       
		document.getElementById("dn-counters").innerHTML = "Дневных " + dayscount + ", ночных "+nightscount;
		let shifts = dayscount + nightscount;
		document.getElementById("sh-counters").innerHTML = "Всего смен " + shifts + ", часов " + shifts *11;
		if (getDay(d) % 7 == 6) { // вс, последний день - перевод строки
          table += '</tr><tr>';
        }
		
        d.setDate(d.getDate() + 1);
      }

      // добить таблицу пустыми ячейками, если нужно
      // 29 30 31 * * * *
      if (getDay(d) != 0) {
        for (let i = getDay(d); i < 7; i++) {
          table += '<td></td>';
        }
      }

      // закрыть таблицу
      table += '</tr></table>';

      elem.innerHTML = table;
    }

    function getDay(date) { // получить номер дня недели, от 0 (пн) до 6 (вс)
      let day = date.getDay();
      if (day == 0) day = 7; // сделать воскресенье (0) последним днем
      return day - 1;
    }
	
	monthset();
    
	function monthchange(direction){
		if (direction=="zero") changemonth=0;
			else changemonth = (direction=="back") ? changemonth-1:	changemonth +1;
		monthset();
	}
	
	function togglesettings(){
		var x = document.getElementById("settings");
		x.style.display = (x.style.display === "none") ? "block" : "none";		
	}
  </script>

</body>
</html>